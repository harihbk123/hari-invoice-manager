<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Check - Invoice Manager</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .check { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #28a745;
            background: white;
        }
        .error { 
            border-left-color: #dc3545; 
            background: #fff5f5;
        }
        .warning { 
            border-left-color: #ffc107; 
            background: #fffbf0;
        }
        .loading {
            border-left-color: #007bff;
            background: #f0f8ff;
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Invoice Manager Health Check</h1>
    <div id="results"></div>
    
    <div style="margin-top: 30px;">
        <button class="btn" onclick="runHealthCheck()">üîÑ Re-run Health Check</button>
        <button class="btn" onclick="window.open('/', '_blank')">üöÄ Open Main App</button>
        <button class="btn" onclick="clearStorage()">üßπ Clear Storage</button>
    </div>

    <script>
        function addResult(message, type = 'check') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            addResult('‚úÖ Storage cleared successfully', 'check');
        }

        async function runHealthCheck() {
            clearResults();
            addResult('üîç Starting comprehensive health check...', 'loading');

            // Check 1: Basic browser support
            try {
                if (typeof fetch === 'undefined') throw new Error('Fetch API not supported');
                if (typeof Promise === 'undefined') throw new Error('Promises not supported');
                if (typeof localStorage === 'undefined') throw new Error('LocalStorage not supported');
                addResult('‚úÖ Browser compatibility: All modern features supported', 'check');
            } catch (error) {
                addResult(`‚ùå Browser compatibility: ${error.message}`, 'error');
            }

            // Check 2: CDN Resources
            const cdnChecks = [
                { name: 'Supabase', url: 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2', global: 'supabase' },
                { name: 'Chart.js', url: 'https://cdn.jsdelivr.net/npm/chart.js', global: 'Chart' },
                { name: 'jsPDF', url: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', global: 'jsPDF' },
                { name: 'Flatpickr', url: 'https://cdn.jsdelivr.net/npm/flatpickr', global: 'flatpickr' }
            ];

            for (const check of cdnChecks) {
                try {
                    const response = await fetch(check.url, { method: 'HEAD' });
                    if (response.ok) {
                        addResult(`‚úÖ CDN Check - ${check.name}: Available (${response.status})`, 'check');
                    } else {
                        addResult(`‚ö†Ô∏è CDN Check - ${check.name}: HTTP ${response.status}`, 'warning');
                    }
                } catch (error) {
                    addResult(`‚ùå CDN Check - ${check.name}: ${error.message}`, 'error');
                }
            }

            // Check 3: Local files
            const localFiles = ['app.js', 'style.css', 'index.html'];
            for (const file of localFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        addResult(`‚úÖ Local File - ${file}: Available (${response.headers.get('content-length')} bytes)`, 'check');
                    } else {
                        addResult(`‚ùå Local File - ${file}: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    addResult(`‚ùå Local File - ${file}: ${error.message}`, 'error');
                }
            }

            // Check 4: Authentication
            try {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                const username = localStorage.getItem('username');
                const loginTime = localStorage.getItem('loginTime');
                
                addResult(`‚úÖ Authentication State: 
                    <br>‚Ä¢ Logged in: ${isLoggedIn || 'null'}
                    <br>‚Ä¢ Username: ${username || 'null'}
                    <br>‚Ä¢ Login time: ${loginTime ? new Date(parseInt(loginTime)).toLocaleString() : 'null'}`, 'check');
            } catch (error) {
                addResult(`‚ùå Authentication Check: ${error.message}`, 'error');
            }

            // Check 5: DOM Structure
            try {
                const requiredElements = ['#dashboard-page', '#expenses-page', '#invoices-page', '#clients-page'];
                const missingElements = [];
                
                // Load and parse the main page to check structure
                const response = await fetch('/');
                const html = await response.text();
                
                for (const selector of requiredElements) {
                    if (!html.includes(selector.substring(1))) {
                        missingElements.push(selector);
                    }
                }
                
                if (missingElements.length === 0) {
                    addResult('‚úÖ DOM Structure: All required page elements found', 'check');
                } else {
                    addResult(`‚ö†Ô∏è DOM Structure: Missing elements: ${missingElements.join(', ')}`, 'warning');
                }
            } catch (error) {
                addResult(`‚ùå DOM Structure Check: ${error.message}`, 'error');
            }

            // Check 6: JavaScript syntax
            try {
                const response = await fetch('/app.js');
                const jsContent = await response.text();
                
                // Basic syntax checks
                const openBraces = (jsContent.match(/{/g) || []).length;
                const closeBraces = (jsContent.match(/}/g) || []).length;
                const openParens = (jsContent.match(/\(/g) || []).length;
                const closeParens = (jsContent.match(/\)/g) || []).length;
                
                if (openBraces === closeBraces && openParens === closeParens) {
                    addResult(`‚úÖ JavaScript Syntax: Basic structure looks good 
                        <br>‚Ä¢ File size: ${jsContent.length} characters
                        <br>‚Ä¢ Braces: ${openBraces} pairs
                        <br>‚Ä¢ Parentheses: ${openParens} pairs`, 'check');
                } else {
                    addResult(`‚ö†Ô∏è JavaScript Syntax: Potential issues detected
                        <br>‚Ä¢ Open braces: ${openBraces}, Close braces: ${closeBraces}
                        <br>‚Ä¢ Open parens: ${openParens}, Close parens: ${closeParens}`, 'warning');
                }
            } catch (error) {
                addResult(`‚ùå JavaScript Syntax Check: ${error.message}`, 'error');
            }

            addResult('üèÅ Health check complete! Review results above.', 'loading');
        }

        // Auto-run on page load
        window.addEventListener('load', runHealthCheck);
    </script>
</body>
</html>
